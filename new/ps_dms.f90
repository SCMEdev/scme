module ps_dms
use constants, only:Bohr_A
implicit none

integer, parameter, dimension(84) :: idxD1 = [&
       1, 1, 1, 2, 1, 1, 1, 2, 2, 3, 1, 1, 1, 1, 2, 2, 2, 3, 3, 4,&
       1, 1, 1, 1, 1, 2, 2, 2, 2, 3, 3, 3, 4, 4, 5, 1, 1, 1, 1, 1,&
       1, 2, 2, 2, 2, 2, 3, 3, 3, 3, 4, 4, 4, 5, 5, 6, 1, 1, 1, 1,&
       1, 1, 1, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 4, 4, 4, 4, 5, 5,&
       5, 6, 6, 7]

integer, parameter, dimension(84) :: idxD2 = [&
       1, 1, 2, 1, 1, 2, 3, 1, 2, 1, 1, 2, 3, 4, 1, 2, 3, 1, 2, 1,&
       1, 2, 3, 4, 5, 1, 2, 3, 4, 1, 2, 3, 1, 2, 1, 1, 2, 3, 4, 5,&
       6, 1, 2, 3, 4, 5, 1, 2, 3, 4, 1, 2, 3, 1, 2, 1, 1, 2, 3, 4,&
       5, 6, 7, 1, 2, 3, 4, 5, 6, 1, 2, 3, 4, 5, 1, 2, 3, 4, 1, 2,&
       3, 1, 2, 1]


integer, parameter, dimension(84) :: idxD3 = [&
       1, 2, 1, 1, 3, 2, 1, 2, 1, 1, 4, 3, 2, 1, 3, 2, 1, 2, 1, 1,&
       5, 4, 3, 2, 1, 4, 3, 2, 1, 3, 2, 1, 2, 1, 1, 6, 5, 4, 3, 2,&
       1, 5, 4, 3, 2, 1, 4, 3, 2, 1, 3, 2, 1, 2, 1, 1, 7, 6, 5, 4,&
       3, 2, 1, 6, 5, 4, 3, 2, 1, 5, 4, 3, 2, 1, 4, 3, 2, 1, 3, 2,&
       1, 2, 1, 1]

real*8, parameter, dimension(84) :: coefD = [&
      -2.1689686086730d-03, 1.4910379754728d-02, 5.3546078430060d-02,&
      -7.4055995388666d-02,-3.7764333017616d-03, 1.4089887256484d-01,&
      -6.2584207687264d-02,-1.1260393113022d-01,-5.7824159269319d-02,&
       1.4360743650655d-02,-1.5469680141070d-02,-1.3036350092795d-02,&
       2.7515837781556d-02, 1.4098478875076d-01,-2.7663168397781d-02,&
      -5.2378176254797d-03,-1.0237198381792d-02, 8.9571999265473d-02,&
       7.2920263098603d-03,-2.6873260551686d-01, 2.0220870325864d-02,&
      -7.0764766270927d-02, 1.2140640273760d-01, 2.0978491966341d-02,&
      -1.9443840512668d-01, 4.0826835370618d-02,-4.5365190474650d-02,&
       6.2779900072132d-02,-1.3194351021000d-01,-1.4673032718563d-01,&
       1.1894031277247d-01,-6.4952851564679d-03, 8.8503610374493d-02,&
       1.4899437409291d-01, 1.3962841511565d-01,-2.6459446720450d-02,&
      -5.0128914532773d-02, 1.8329676428116d-01,-1.5559089125095d-01,&
      -4.0176879767592d-02, 3.6192059996636d-01, 1.0202887240343d-01,&
       1.9318668580051d-01,-4.3435977107932d-01,-4.2080828803311d-02,&
       1.9144626027273d-01,-1.7851138969948d-01, 1.0524533875070d-01,&
      -1.7954071602185d-02, 5.2022455612120d-02,-2.8891891146828d-01,&
      -4.7452036576319d-02,-1.0939400546289d-01, 3.5916564473568d-01,&
      -2.0162789820172d-01,-3.5838629543696d-01, 5.6706523551202d-03,&
       1.3849337488211d-01,-4.1733982195604d-01, 4.1641570764241d-01,&
      -1.2243429796296d-01, 4.7141730971228d-02,-1.8224510249551d-01,&
      -1.8880981556620d-01,-3.1992359561800d-01,-1.8567550546587d-01,&
       6.1850530431280d-01,-6.1142756235141d-02,-1.6996135584933d-01,&
       5.4252879499871d-01, 6.6128603899427d-01, 1.2107016404639d-02,&
      -1.9633639729189d-01, 2.7652059420824d-03,-2.2684111109778d-01,&
      -4.7924491598635d-01, 2.4287790137314d-01,-1.4296023329441d-01,&
       8.9664665907006d-02,-1.4003228575602d-01,-1.3321543452254d-01,&
      -1.8340983193745d-01, 2.3426707273520d-01, 1.5141050914514d-01]


!real*8, parameter :: b2A     = 0.52917721067000000000d0 !nist value bohr in ångström 
!                               
!real*8, parameter :: A2b     = 1.88972612545782819321d0 !Ångström to Bohr
!real*8, parameter :: au2deb  = 2.541746230211d0 !a.u. to debye

real*8,parameter :: reoh = 0.958649d0
real*8,parameter :: b1D =  1.0d0
real*8,parameter :: a   =  0.2999d0
real*8,parameter :: b   = -0.6932d0

real*8,parameter :: c0  =  1.0099d0
real*8,parameter :: c1  = -0.1801d0
real*8,parameter :: c2  =  0.0892d0

real*8,parameter :: costhe = -0.24780227221366464506d0

private
public dmsnasa

contains !//////////////////////////////////////////////////////////////

   subroutine dmsnasa(rr,dd)
    real*8 , intent(in)  :: rr(3,3)!x(3,3) x(OHH,xyz)
    real*8 , intent(out) :: dd(3)
    real*8 :: efac, xpow(3,7) !,x1,x2,x3 !7 should be enough
    real*8 :: p1, p2, pl1, pl2,x(3)
    
    real*8 :: v1(3), v2(3), vhh(3), r1, r2, rhh, costh, pc0
    integer inI, inJ, inK,j
      
      v1  = ( rr(2,:) - rr(1,:) )!*A2b !rr(i,2,:) - rr(i,1,:) !H1-O
      v2  = ( rr(3,:) - rr(1,:) )!*A2b !rr(i,3,:) - rr(i,1,:) !H2-O
      
      !r1  = dsqrt(sum( v1*v1 ))
      !r2  = dsqrt(sum( v2*v2 ))
      !costh = sum(v1*v2) / (r1*r2) !=cos(HOH) 
      
      r1  = dsqrt( v1(1)*v1(1) + v1(2)*v1(2) + v1(3)*v1(3) )
      r2  = dsqrt( v2(1)*v2(1) + v2(2)*v2(2) + v2(3)*v2(3) )
      costh = ( v1(1)*v2(1) + v1(2)*v2(2) + v1(3)*v2(3) ) /(r1*r2)
      
      
      efac = dexp(-b1D*( (r1-reoh)**2 + (r2-reoh)**2 ) )
      
      x = [ (r1-reoh)/reoh , (r2-reoh)/reoh , (costh - costhe) ]
      
      xpow(:,1) = 1d0
      do j = 2,7 ! powers of the x-vector
          xpow(:,j) = xpow(:,j-1)*x(:)
      enddo
      
      ! Calculate the dipole moment
      
      p1=0d0
      p2=0d0
      
      do j=2,84 !(size_t j = 1; j < 84; ++j) {
          inI = idxD1(j)
          inJ = idxD2(j)
          inK = idxD3(j)
          
          p1 = p1 + coefD(j)*xpow(1,inI)*xpow(2,inJ)*xpow(3,inK)
          p2 = p2 + coefD(j)*xpow(1,inJ)*xpow(2,inI)*xpow(3,inK)
      enddo
      
      pl1 = costh;
      pl2 = 0.5d0*(3d0*pl1*pl1 - 1d0)
      pc0 = a*( r1**b + r2**b )*(c0 + pl1*c1 + pl2*c2)
      
      p1 = coefD(1) + p1*efac + pc0*Bohr_A !; // q^H1 in TTM2-F
      p2 = coefD(1) + p2*efac + pc0*Bohr_A !; // q^H2 paper
          
!          //JÖ code snipped equivalent to the PS Fortran routine
      dd = ( p1*v1 + p2*v2 )/Bohr_A
      
   end subroutine
end module


      !r1  = dsqrt( v1(1)*v1(1) + v1(2)*v1(2) + v1(3)*v1(3) )
      !r2  = dsqrt( v2(1)*v2(1) + v2(2)*v2(2) + v2(3)*v2(3) )
      !costh = ( v1(1)*v2(1) + v1(2)*v2(2) + v1(3)*v2(3) ) /(r1*r2)
      
      !x1 = (r1 - reoh)/reoh
      !x2 = (r2 - reoh)/reoh
      !x3 = costh - costhe
      !x = [x1,x2,x3]
      
