      
module ps_pes      
!use constants, only:a0_A, A_a0,cm1_eV !bohr in ansgtrom, angstrom in bohr, cm-1 in eV
use data_types, only:dp  ,a0_A, A_a0,cm1_eV             !integer, parameter :: dp = selected_real_kind(15, 307)
implicit none
!-----------------------------------------------------------------------
!      subroutine vibpot(rij,v,n)
!      implicit real*8 (a-h,o-z)
!
!     pes for h2o,
!     Harry Partridge and David W. Schwenke, J. Chem. Phys.,
!     submitted Aug. 28, 1996.
!     rij(i,1)& rij(i,2) are oh distances in au
!     rij(i,3) is hoh angle in rad
!     v(i) is pes in au
!     n is number of geometries
!
!-----------------------------------------------------------------------
!     Changes from original source is made by Jonatan Öström in 
!     2016-12-12. 
!-----------------------------------------------------------------------
       integer,parameter,dimension(245) :: idx1 = [ &
        1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, &
        2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, &
        2, 2, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, &
        3, 3, 3, 3, 3, 3, 3, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 3, &
        3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, &
        4, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 4, 4, 4, 4, 4, 4, 4, 4, &
        4, 4, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 6, 6, 6, 6, 6, 6, 6, 6, &
        6, 6, 4, 4, 4, 4, 4, 4, 4, 4, 4, 5, 5, 5, 5, 5, 5, 5, 5, 5, &
        6, 6, 6, 6, 6, 6, 6, 6, 6, 7, 7, 7, 7, 7, 7, 7, 7, 7, 5, 5, &
        5, 5, 5, 5, 5, 5, 6, 6, 6, 6, 6, 6, 6, 6, 7, 7, 7, 7, 7, 7, &
        7, 7, 8, 8, 8, 8, 8, 8, 8, 8, 5, 5, 5, 5, 5, 5, 5, 6, 6, 6, &
        6, 6, 6, 6, 7, 7, 7, 7, 7, 7, 7, 8, 8, 8, 8, 8, 8, 8, 9, 9, &
        9, 9, 9, 9, 9]
       integer,parameter,dimension(245) :: idx2 = [ &
        1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, &
        1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, &
        2, 2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, &
        2, 2, 2, 2, 2, 2, 2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 3, &
        3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, &
        2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 3, 3, 3, 3, 3, 3, 3, 3, &
        3, 3, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 1, 1, 1, 1, 1, 1, 1, 1, &
        1, 1, 4, 4, 4, 4, 4, 4, 4, 4, 4, 3, 3, 3, 3, 3, 3, 3, 3, 3, &
        2, 2, 2, 2, 2, 2, 2, 2, 2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 4, 4, &
        4, 4, 4, 4, 4, 4, 3, 3, 3, 3, 3, 3, 3, 3, 2, 2, 2, 2, 2, 2, &
        2, 2, 1, 1, 1, 1, 1, 1, 1, 1, 5, 5, 5, 5, 5, 5, 5, 4, 4, 4, &
        4, 4, 4, 4, 3, 3, 3, 3, 3, 3, 3, 2, 2, 2, 2, 2, 2, 2, 1, 1, &
        1, 1, 1, 1, 1]
       integer,parameter,dimension(245) :: idx3 = [ &
       1, 2, 3, 4, 5, 6, 7, 8, 9,10,11,12,13,14,15, 1, 2, 3, 4, 5, &
        6, 7, 8, 9,10,11,12,13,14, 1, 2, 3, 4, 5, 6, 7, 8, 9,10,11, &
       12,13, 1, 2, 3, 4, 5, 6, 7, 8, 9,10,11,12,13, 1, 2, 3, 4, 5, &
        6, 7, 8, 9,10,11,12, 1, 2, 3, 4, 5, 6, 7, 8, 9,10,11,12, 1, &
        2, 3, 4, 5, 6, 7, 8, 9,10,11, 1, 2, 3, 4, 5, 6, 7, 8, 9,10, &
       11, 1, 2, 3, 4, 5, 6, 7, 8, 9,10,11, 1, 2, 3, 4, 5, 6, 7, 8, &
        9,10, 1, 2, 3, 4, 5, 6, 7, 8, 9,10, 1, 2, 3, 4, 5, 6, 7, 8, &
        9,10, 1, 2, 3, 4, 5, 6, 7, 8, 9, 1, 2, 3, 4, 5, 6, 7, 8, 9, &
        1, 2, 3, 4, 5, 6, 7, 8, 9, 1, 2, 3, 4, 5, 6, 7, 8, 9, 1, 2, &
        3, 4, 5, 6, 7, 8, 1, 2, 3, 4, 5, 6, 7, 8, 1, 2, 3, 4, 5, 6, &
        7, 8, 1, 2, 3, 4, 5, 6, 7, 8, 1, 2, 3, 4, 5, 6, 7, 1, 2, 3, &
        4, 5, 6, 7, 1, 2, 3, 4, 5, 6, 7, 1, 2, 3, 4, 5, 6, 7, 1, 2, &
        3, 4, 5, 6, 7]
       real(dp), parameter :: c5z_temp(245) = [ &
        4.2278462684916e+04_dp, 4.5859382909906e-02_dp, 9.4804986183058e+03_dp, &
        7.5485566680955e+02_dp, 1.9865052511496e+03_dp, 4.3768071560862e+02_dp, &
        1.4466054104131e+03_dp, 1.3591924557890e+02_dp,-1.4299027252645e+03_dp, &
        6.6966329416373e+02_dp, 3.8065088734195e+03_dp,-5.0582552618154e+02_dp, &
       -3.2067534385604e+03_dp, 6.9673382568135e+02_dp, 1.6789085874578e+03_dp, &
       -3.5387509130093e+03_dp,-1.2902326455736e+04_dp,-6.4271125232353e+03_dp, &
       -6.9346876863641e+03_dp,-4.9765266152649e+02_dp,-3.4380943579627e+03_dp, &
        3.9925274973255e+03_dp,-1.2703668547457e+04_dp,-1.5831591056092e+04_dp, &
        2.9431777405339e+04_dp, 2.5071411925779e+04_dp,-4.8518811956397e+04_dp, &
       -1.4430705306580e+04_dp, 2.5844109323395e+04_dp,-2.3371683301770e+03_dp, &
        1.2333872678202e+04_dp, 6.6525207018832e+03_dp,-2.0884209672231e+03_dp, &
       -6.3008463062877e+03_dp, 4.2548148298119e+04_dp, 2.1561445953347e+04_dp, &
       -1.5517277060400e+05_dp, 2.9277086555691e+04_dp, 2.6154026873478e+05_dp, &
       -1.3093666159230e+05_dp,-1.6260425387088e+05_dp, 1.2311652217133e+05_dp, &
       -5.1764697159603e+04_dp, 2.5287599662992e+03_dp, 3.0114701659513e+04_dp, &
       -2.0580084492150e+03_dp, 3.3617940269402e+04_dp, 1.3503379582016e+04_dp, &
       -1.0401149481887e+05_dp,-6.3248258344140e+04_dp, 2.4576697811922e+05_dp, &
        8.9685253338525e+04_dp,-2.3910076031416e+05_dp,-6.5265145723160e+04_dp, &
        8.9184290973880e+04_dp,-8.0850272976101e+03_dp,-3.1054961140464e+04_dp, &
       -1.3684354599285e+04_dp, 9.3754012976495e+03_dp,-7.4676475789329e+04_dp, &
       -1.8122270942076e+05_dp, 2.6987309391410e+05_dp, 4.0582251904706e+05_dp, &
       -4.7103517814752e+05_dp,-3.6115503974010e+05_dp, 3.2284775325099e+05_dp, &
        1.3264691929787e+04_dp, 1.8025253924335e+05_dp,-1.2235925565102e+04_dp, &
       -9.1363898120735e+03_dp,-4.1294242946858e+04_dp,-3.4995730900098e+04_dp, &
        3.1769893347165e+05_dp, 2.8395605362570e+05_dp,-1.0784536354219e+06_dp, &
       -5.9451106980882e+05_dp, 1.5215430060937e+06_dp, 4.5943167339298e+05_dp, &
       -7.9957883936866e+05_dp,-9.2432840622294e+04_dp, 5.5825423140341e+03_dp, &
        3.0673594098716e+03_dp, 8.7439532014842e+04_dp, 1.9113438435651e+05_dp, &
       -3.4306742659939e+05_dp,-3.0711488132651e+05_dp, 6.2118702580693e+05_dp, &
       -1.5805976377422e+04_dp,-4.2038045404190e+05_dp, 3.4847108834282e+05_dp, &
       -1.3486811106770e+04_dp, 3.1256632170871e+04_dp, 5.3344700235019e+03_dp, &
        2.6384242145376e+04_dp, 1.2917121516510e+05_dp,-1.3160848301195e+05_dp, &
       -4.5853998051192e+05_dp, 3.5760105069089e+05_dp, 6.4570143281747e+05_dp, &
       -3.6980075904167e+05_dp,-3.2941029518332e+05_dp,-3.5042507366553e+05_dp, &
        2.1513919629391e+03_dp, 6.3403845616538e+04_dp, 6.2152822008047e+04_dp, &
       -4.8805335375295e+05_dp,-6.3261951398766e+05_dp, 1.8433340786742e+06_dp, &
        1.4650263449690e+06_dp,-2.9204939728308e+06_dp,-1.1011338105757e+06_dp, &
        1.7270664922758e+06_dp, 3.4925947462024e+05_dp,-1.9526251371308e+04_dp, &
       -3.2271030511683e+04_dp,-3.7601575719875e+05_dp, 1.8295007005531e+05_dp, &
        1.5005699079799e+06_dp,-1.2350076538617e+06_dp,-1.8221938812193e+06_dp, &
        1.5438780841786e+06_dp,-3.2729150692367e+03_dp, 1.0546285883943e+04_dp, &
       -4.7118461673723e+04_dp,-1.1458551385925e+05_dp, 2.7704588008958e+05_dp, &
        7.4145816862032e+05_dp,-6.6864945408289e+05_dp,-1.6992324545166e+06_dp, &
        6.7487333473248e+05_dp, 1.4361670430046e+06_dp,-2.0837555267331e+05_dp, &
        4.7678355561019e+05_dp,-1.5194821786066e+04_dp,-1.1987249931134e+05_dp, &
        1.3007675671713e+05_dp, 9.6641544907323e+05_dp,-5.3379849922258e+05_dp, &
       -2.4303858824867e+06_dp, 1.5261649025605e+06_dp, 2.0186755858342e+06_dp, &
       -1.6429544469130e+06_dp,-1.7921520714752e+04_dp, 1.4125624734639e+04_dp, &
       -2.5345006031695e+04_dp, 1.7853375909076e+05_dp,-5.4318156343922e+04_dp, &
       -3.6889685715963e+05_dp, 4.2449670705837e+05_dp, 3.5020329799394e+05_dp, &
        9.3825886484788e+03_dp,-8.0012127425648e+05_dp, 9.8554789856472e+04_dp, &
        4.9210554266522e+05_dp,-6.4038493953446e+05_dp,-2.8398085766046e+06_dp, &
        2.1390360019254e+06_dp, 6.3452935017176e+06_dp,-2.3677386290925e+06_dp, &
       -3.9697874352050e+06_dp,-1.9490691547041e+04_dp, 4.4213579019433e+04_dp, &
        1.6113884156437e+05_dp,-7.1247665213713e+05_dp,-1.1808376404616e+06_dp, &
        3.0815171952564e+06_dp, 1.3519809705593e+06_dp,-3.4457898745450e+06_dp, &
        2.0705775494050e+05_dp,-4.3778169926622e+05_dp, 8.7041260169714e+03_dp, &
        1.8982512628535e+05_dp,-2.9708215504578e+05_dp,-8.8213012222074e+05_dp, &
        8.6031109049755e+05_dp, 1.0968800857081e+06_dp,-1.0114716732602e+06_dp, &
        1.9367263614108e+05_dp, 2.8678295007137e+05_dp,-9.4347729862989e+04_dp, &
        4.4154039394108e+04_dp, 5.3686756196439e+05_dp, 1.7254041770855e+05_dp, &
       -2.5310674462399e+06_dp,-2.0381171865455e+06_dp, 3.3780796258176e+06_dp, &
        7.8836220768478e+05_dp,-1.5307728782887e+05_dp,-3.7573362053757e+05_dp, &
        1.0124501604626e+06_dp, 2.0929686545723e+06_dp,-5.7305706586465e+06_dp, &
       -2.6200352535413e+06_dp, 7.1543745536691e+06_dp,-1.9733601879064e+04_dp, &
        8.5273008477607e+04_dp, 6.1062454495045e+04_dp,-2.2642508675984e+05_dp, &
        2.4581653864150e+05_dp,-9.0376851105383e+05_dp,-4.4367930945690e+05_dp, &
        1.5740351463593e+06_dp, 2.4563041445249e+05_dp,-3.4697646046367e+03_dp, &
       -2.1391370322552e+05_dp, 4.2358948404842e+05_dp, 5.6270081955003e+05_dp, &
       -8.5007851251980e+05_dp,-6.1182429537130e+05_dp, 5.6690751824341e+05_dp, &
       -3.5617502919487e+05_dp,-8.1875263381402e+02_dp,-2.4506258140060e+05_dp, &
        2.5830513731509e+05_dp, 6.0646114465433e+05_dp,-6.9676584616955e+05_dp, &
        5.1937406389690e+05_dp, 1.7261913546007e+05_dp,-1.7405787307472e+04_dp, &
       -3.8301842660567e+05_dp, 5.4227693205154e+05_dp, 2.5442083515211e+06_dp, &
       -1.1837755702370e+06_dp,-1.9381959088092e+06_dp,-4.0642141553575e+05_dp, &
        1.1840693827934e+04_dp,-1.5334500255967e+05_dp, 4.9098619510989e+05_dp, &
        6.1688992640977e+05_dp, 2.2351144690009e+05_dp,-1.8550462739570e+06_dp, &
        9.6815110649918e+03_dp,-8.1526584681055e+04_dp,-8.0810433155289e+04_dp, &
        3.4520506615177e+05_dp, 2.5509863381419e+05_dp,-1.3331224992157e+05_dp, &
       -4.3119301071653e+05_dp,-5.9818343115856e+04_dp, 1.7863692414573e+03_dp, &
        8.9440694919836e+04_dp,-2.5558967650731e+05_dp,-2.2130423988459e+04_dp, &
        4.4973674518316e+05_dp,-2.2094939343618e+05_dp]
       real(dp), parameter :: cbasis(245) = [ & 
        6.9770019624764e-04_dp,-2.4209870001642e+01_dp, 1.8113927151562e+01_dp, &
        3.5107416275981e+01_dp,-5.4600021126735e+00_dp,-4.8731149608386e+01_dp, &
        3.6007189184766e+01_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
       -7.7178474355102e+01_dp,-3.8460795013977e+01_dp,-4.6622480912340e+01_dp, &
        5.5684951167513e+01_dp, 1.2274939911242e+02_dp,-1.4325154752086e+02_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp,-6.0800589055949e+00_dp, &
        8.6171499453475e+01_dp,-8.4066835441327e+01_dp,-5.8228085624620e+01_dp, &
        2.0237393793875e+02_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        3.3525582670313e+02_dp, 7.0056962392208e+01_dp,-4.5312502936708e+01_dp, &
       -3.0441141194247e+02_dp, 2.8111438108965e+02_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp,-1.2983583774779e+02_dp, 3.9781671212935e+01_dp, &
       -6.6793945229609e+01_dp,-1.9259805675433e+02_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp,-8.2855757669957e+02_dp,-5.7003072730941e+01_dp, &
       -3.5604806670066e+01_dp, 9.6277766002709e+01_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 8.8645622149112e+02_dp,-7.6908409772041e+01_dp, &
        6.8111763314154e+01_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        2.5090493428062e+02_dp,-2.3622141780572e+02_dp, 5.8155647658455e+02_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 2.8919570295095e+03_dp, &
       -1.7871014635921e+02_dp,-1.3515667622500e+02_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp,-3.6965613754734e+03_dp, 2.1148158286617e+02_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp,-1.4795670139431e+03_dp, &
        3.6210798138768e+02_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
       -5.3552886800881e+03_dp, 3.1006384016202e+02_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 1.6241824368764e+03_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 4.3764909606382e+03_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 1.0940849243716e+03_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 3.0743267832931e+03_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp]
       real(dp), parameter :: ccore(245) = [ & 
        2.4332191647159e-02_dp,-2.9749090113656e+01_dp, 1.8638980892831e+01_dp, &
       -6.1272361746520e+00_dp, 2.1567487597605e+00_dp,-1.5552044084945e+01_dp, &
        8.9752150543954e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
       -3.5693557878741e+02_dp,-3.0398393196894e+00_dp,-6.5936553294576e+00_dp, &
        1.6056619388911e+01_dp, 7.8061422868204e+01_dp,-8.6270891686359e+01_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp,-3.1688002530217e+01_dp, &
        3.7586725583944e+01_dp,-3.2725765966657e+01_dp,-5.6458213299259e+00_dp, &
        2.1502613314595e+01_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        5.2789943583277e+02_dp,-4.2461079404962e+00_dp,-2.4937638543122e+01_dp, &
       -1.1963809321312e+02_dp, 2.0240663228078e+02_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp,-6.2574211352272e+02_dp,-6.9617539465382e+00_dp, &
       -5.9440243471241e+01_dp, 1.4944220180218e+01_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp,-1.2851139918332e+03_dp,-6.5043516710835e+00_dp, &
        4.0410829440249e+01_dp,-6.7162452402027e+01_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 1.0031942127832e+03_dp, 7.6137226541944e+01_dp, &
       -2.7279242226902e+01_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
       -3.3059000871075e+01_dp, 2.4384498749480e+01_dp,-1.4597931874215e+02_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 1.6559579606045e+03_dp, &
        1.5038996611400e+02_dp,-7.3865347730818e+01_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp,-1.9738401290808e+03_dp,-1.4149993809415e+02_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp,-1.2756627454888e+02_dp, &
        4.1487702227579e+01_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
       -1.7406770966429e+03_dp,-9.3812204399266e+01_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp,-1.1890301282216e+03_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 2.3723447727360e+03_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp,-1.0279968223292e+03_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 5.7153838472603e+02_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp]                  
       real(dp), parameter :: crest(245) = [ & 
        0.0000000000000e+00_dp,-4.7430930170000e+00_dp,-1.4422132560000e+01_dp, &
       -1.8061146510000e+01_dp, 7.5186735000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
       -2.7962099800000e+02_dp, 1.7616414260000e+01_dp,-9.9741392630000e+01_dp, &
        7.1402447000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp,-7.8571336480000e+01_dp, &
        5.2434353250000e+01_dp, 7.7696745000000e+01_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        1.7799123760000e+02_dp, 1.4564532380000e+02_dp, 2.2347226000000e+02_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp,-4.3823284100000e+02_dp,-7.2846553000000e+02_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp,-2.6752313750000e+02_dp, 3.6170310000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp, 0.0000000000000e+00_dp, &
        0.0000000000000e+00_dp, 0.0000000000000e+00_dp]
       
       real(dp), parameter :: f5z        =     0.99967788500000_dp
       real(dp), parameter :: fbasis     =     0.15860145369897_dp
       real(dp), parameter :: fcore      =    -1.6351695982132_dp
       real(dp), parameter :: frest      =     1.0_dp
       real(dp), parameter :: b1         =     2.0_dp!*b2A**2
       real(dp), parameter :: roh        =     0.9519607159623009_dp!/b2A
       real(dp), parameter :: alphaoh    =     2.587949757553683_dp!*b2A
       real(dp), parameter :: deoh       = 42290.92019288289_dp*f5z!*cm2au
       real(dp), parameter :: reoh       =     0.958649_dp!/b2A
       real(dp), parameter :: thetae     =   104.3475_dp
       !real(dp), parameter :: rad        = dacos(-1.0_dp)/1.8e2_dp                   !took value from potnasa
       real(dp), parameter :: cos_thetae =    -0.24780227221366464506_dp!dcos(thetae*rad) !took value from potnasa !if thetae changes this must change too!
       real(dp), parameter :: phh2       =    12.66426998162947_dp!*b2A
       real(dp), parameter :: phh1       =    16.94879431193463_dp*dexp(phh2)*f5z!/b2A)*f5z*cm2au ! )*f5z!
       real(dp), parameter :: c5z(245)   = &                                                                             
              ( f5z*c5z_temp(:) + fbasis*cbasis(:) + fcore*ccore(:) + frest*crest(:) ) !Below is the 2 (present in vibpot)

private
public vibpes

contains !//////////////////////////////////////////////////////////////

   subroutine vibpes(x,v,dvdr)
   !--------------------------------------------------------------------
   !> Description 
   !   x(3,3) is the input coordinates of O, H1, H2. [in Angstrom]
   !   x(1,:) is the coords. of O
   !   x(2,:) is the coords. of H1
   !   x(2,1) is the x-coord. of H1
   !   x(2,2) is the y-coord. of H1 etc
   !    etc.
   !   
   !   v is the scalar potential energy result [in eV]
   !   
   !   dvdr(9)   is the pot. energy gradient result [in eV/Angstrom]
   !   dvdr(1:3) is the x,y,z conmponents of the O gradient
   !   dvdr(4:6) is the x,y,z conmponents of the H1 gradient
   !   dvdr(1)   is the x conmponent of the O gradient
   !    etc.
   !
   !> Author
   ! This routine is "written" by Jonatan Öström.                        
   ! It is built from the 'vibpot' routine of H Partridge and D Schwenke
   ! and the gradient calculation from the 'potnasa' routine by ...?
   ! The first lines converting from coordinates to internal coordinates
   ! was taken from 'vibdip' by P and S.  
   ! It is numerically equivalent to 'potnasa', if the "correction" 
   ! below is kept, to the 14th decimal point. 
   ! The descrepancy to full double precision equivalence, 
   ! materialized in the summation order the terms in 'v' below.
   ! The reason for that I am not sure of.                         
   !--------------------------------------------------------------------
     real(dp) , intent(in)  :: x(3,3)    !x(xyz,OHH)
     real(dp) , intent(out) :: v,dvdr(3,3)!,dvdr(9)! !v(n),dr(9,n) 
     
   !internal variables       
     real(dp) :: x1,x2,x3,xx(3)  
     real(dp) :: xpow(15,3),cos_hoh
     real(dp) :: rr1(3),rr2(3),rr12(3), r1,r2,rhh
     real(dp) :: sum0,sum3,sum1,sum2
     real(dp) :: efac,exp1,exp2
     real(dp) :: dvoh1,dvoh2,dvhh,dVcdr1,dVcdr2,dVcdcth 
     real(dp) :: voh12,vhh
     integer ii, j
     integer idx10,idx20,idx30,idx11,idx21,idx31
     logical, parameter :: do_grad = .true.!.false.
     
     !do i=1,n
     !print*, ce
     
     !OHH order; rr is vector distance      
     rr1  = ( x(:,1) - x(:,3) ) !H1-O
     rr2  = ( x(:,2) - x(:,3) ) !H2-O
     rr12 = ( x(:,1) - x(:,2) ) !H1-H2
     
     !r=norm(rr) is scalara distance
     r1  = sqrt(sum( rr1**2 ))
     r2  = sqrt(sum( rr2**2 ))
     rhh = sqrt(sum( rr12**2 ))
     
     cos_hoh = ( rr1(1)*rr2(1) + rr1(2)*rr2(2) + rr1(3)*rr2(3) ) / (r1*r2) !=cos(HOH) 
     
     !PES coordinates
     x1 = (r1-reoh)/reoh 
     x2 = (r2-reoh)/reoh
     x3 = cos_hoh-cos_thetae
     xx = [x1,x2,x3]
     
     
     exp1=dexp(-alphaoh*(r1-roh))
     exp2=dexp(-alphaoh*(r2-roh))
     
     voh12=deoh*( exp1*(exp1-2.0_dp) + exp2*(exp2-2.0_dp) ) !Va in potnasa & voh1+voh2 in "vibpot" 
     vhh=phh1*dexp(-phh2*rhh)                         !Vb in potnasa
     
     efac = dexp(-b1*(  (r1-reoh)**2 + (r2-reoh)**2  ))
     
     xpow(1,:)=1.0_dp !fmat in vibpot & potnasa
     do j=2,15
        xpow(j,:)=xpow(j-1,:)*xx(:)
     enddo
        
     if (.not.do_grad)then
        sum0 = 0
        do j=2,245
            sum0 = sum0 + c5z(j)*(xpow(idx1(j),1)*xpow(idx2(j),2) + xpow(idx2(j),1)*xpow(idx1(j),2)) * xpow(idx3(j),3)
        enddo
        !Potential:
        v=sum0*efac + (voh12+vhh) + c5z(1)*2.0_dp !here is the 2 
     else 
        sum0 = 0
        sum1 = 0
        sum2 = 0
        sum3 = 0
        do j=2,245
           idx10 =  idx1(j)    !inI = idx1[j] (in potnasa)
           idx20 =  idx2(j)    !inJ = idx2[j]
           idx30 =  idx3(j)    !inK = idx3[j]
           idx11 = (idx10-1)
           idx21 = (idx20-1)
           idx31 = (idx30-1)
           
           sum0  = sum0 + c5z(j)*( xpow(idx10,1)*xpow(idx20,2) + xpow(idx20,1)*xpow(idx10,2) )*xpow(idx30,3)
           sum3  = sum3 + c5z(j)*( xpow(idx10,1)*xpow(idx20,2) + xpow(idx20,1)*xpow(idx10,2) )*idx31*xpow(idx31,3)
           sum1  = sum1 + c5z(j)*( idx11*xpow(idx11,1)*xpow(idx20,2) + idx21*xpow(idx21,1)*xpow(idx10,2) )*xpow(idx30,3)
           sum2  = sum2 + c5z(j)*( idx21*xpow(idx10,1)*xpow(idx21,2) + idx11*xpow(idx20,1)*xpow(idx11,2) )*xpow(idx30,3)
     
        enddo
        
        !Gradient:
        dvoh1= 2.0_dp*alphaoh*deoh*exp1*(1.0_dp - exp1)/r1; !dVa1 in potnasa
        dvoh2= 2.0_dp*alphaoh*deoh*exp2*(1.0_dp - exp2)/r2; !dVa2 in potnasa
        dvhh = -phh2*vhh/rhh                          !Vb   in potnasa
          
        dVcdr1 = (-2.0_dp*b1*efac*(r1 - reoh)*sum0 + efac*sum1/reoh)/r1 ! same as potnasa
        dVcdr2 = (-2.0_dp*b1*efac*(r2 - reoh)*sum0 + efac*sum2/reoh)/r2 ! same as potnasa 
        dVcdcth = efac*sum3                                          ! same as potnasa
        
        do ii = 1,3 !ii=xyz
             !dvdr(0 + ii) = dvoh1*rr1(ii) + dvhh*rr12(ii) + dVcdr1*rr1(ii) + dVcdcth*(rr2(ii)/(r1*r2) - cos_hoh*rr1(ii)/(r1*r1)) !H1
             !dvdr(3 + ii) = dvoh2*rr2(ii) - dvhh*rr12(ii) + dVcdr2*rr2(ii) + dVcdcth*(rr1(ii)/(r1*r2) - cos_hoh*rr2(ii)/(r2*r2)) !H2
             !dvdr(6 + ii) = -( dvdr(0 + ii) + dvdr(3 + ii) ) ! O 
             
             dvdr(ii,1) = dvoh1*rr1(ii) + dvhh*rr12(ii) + dVcdr1*rr1(ii) + dVcdcth*(rr2(ii)/(r1*r2) - cos_hoh*rr1(ii)/(r1*r1)) !H1
             dvdr(ii,2) = dvoh2*rr2(ii) - dvhh*rr12(ii) + dVcdr2*rr2(ii) + dVcdcth*(rr1(ii)/(r1*r2) - cos_hoh*rr2(ii)/(r2*r2)) !H2
             dvdr(ii,3) = -( dvdr(ii,1) + dvdr(ii,2) ) ! O 
             
        enddo
        dvdr=dvdr*cm1_eV
        
        !Potentail:
        v=sum0*efac + (voh12+vhh) + c5z(1)*2.0_dp !here is 2 again
        v = v + 0.44739574026257_dp !// correction ??? 
        v=v  *cm1_eV!*h2eV
        
     endif
     !enddo
   end subroutine
end module


!       
!       real*8, parameter :: b2A     = Bohr_A
!       real*8, parameter :: A2b     = A_Bohr !Ångström to Bohr       
!       real*8, parameter :: h2eV    = 27.211396132d0 !hartree to eV       
!       real*8, parameter :: cm2au   = 4.556335d-6
!       real*8, parameter :: f5z     = 0.99967788500000d0
!       real*8, parameter :: fbasis  = 0.15860145369897d0
!       real*8, parameter :: fcore   = -1.6351695982132d0
!       real*8, parameter :: frest   = 1d0
!
!       real*8, parameter :: b1      = 2.0d0*b2A**2
!       real*8, parameter :: roh     = 0.9519607159623009d0/b2A
!       real*8, parameter :: alphaoh = 2.587949757553683d0*b2A
!       real*8, parameter :: deoh    = 42290.92019288289d0*f5z*cm2au
!       real*8, parameter :: reoh    = 0.958649d0/b2A
!       real*8, parameter :: thetae  = 104.3475d0
!       real*8, parameter :: rad     = dacos(-1d0)/1.8d2
!       real*8, parameter :: ce      = dcos(thetae*rad)
!       real*8, parameter :: phh2    = 12.66426998162947d0*b2A
!       real*8, parameter :: phh1    = 16.94879431193463d0*cm2au*dexp(phh2/b2A)*f5z
!       !real*8, parameter :: c5z(245) = &
!       !     [ ( f5z*c5zt(1)*2d0 + fbasis*cbasis(1)*2d0 + fcore*ccore(1)*2d0 + frest*crest(1)*2d0 ),&
!       !       ( f5z*c5zt(2:245) + fbasis*cbasis(2:245) + fcore*ccore(2:245) + frest*crest(2:245) )  ]*cm2au
!       
!       real*8, parameter :: c5z(245) = &                                                                             
!              ( f5z*c5z_temp(:) + fbasis*cbasis(:) + fcore*ccore(:) + frest*crest(:) )*cm2au ! Down There is the twooo 2 !!
!              !                                                                                                      \/
!
       
       !real*8, parameter :: b2A     = a0_A
       !real*8, parameter :: A2b     = A_a0 !Ångström to Bohr       
       !real*8, parameter :: h2eV    = 27.211396132d0 !hartree to eV       
       !real*8, parameter :: cm2au   = 4.556335d-6


         !x1=(rij(i,1)-reoh)/reoh
         !x2=(rij(i,2)-reoh)/reoh
         !x3=dcos(rij(i,3))-ce
         
         !rhh=dsqrt( r1**2 + r2**2 -2d0*r1*r2*cos_hoh ) !JÖ dcos(rij(i,3)))   | This is formula a**2 = b**2 + c**2 -2*b*c*cos(a_ang), where a_ang is the angle opposite to side a of triangle. 
         !vhh=phh1*dexp(-phh2*rhh)



      
         !fmat(1,1)=1d0
         !fmat(1,2)=1d0
         !fmat(1,3)=1d0

            !fmat(j,1)=fmat(j-1,1)*x1
            !fmat(j,2)=fmat(j-1,2)*x2
            !fmat(j,3)=fmat(j-1,3)*x3



   !            temp = temp + c5z(j)*(fmat(idx(j,1),1)*fmat(idx(j,2),2) + fmat(idx(j,2),1)*fmat(idx(j,1),2)) * fmat(idx(j,3),3)
               
   !            tem1 = tem1 + c5z(j)*(idx11       *fmat(idx11,1)     *fmat(idx20,2)    + idx21       *fmat(idx21,1)     *fmat(idx10,2))   *fmat(idx30,3)
   !           !sum1 = sum1 + c5z[j]*((inI - 1)   *fmat[0][inI - 1]  *fmat[1][inJ]     + (inJ - 1)   *fmat[0][inJ - 1]  *fmat[1][inI])   *fmat[2][inK];
   !           !tem1 = tem1 + c5z(j)*((idx(j,1)-1)*fmat(idx(j,1)-1,1)*fmat(idx(j,2),2) + (idx(j,2)-1)*fmat(idx(j,2)-1,1)*fmat(idx(j,1),2)*fmat(idx(j,3),3)
   !            tem2 = tem2 + c5z(j)*(idx21    *fmat(idx10,1) *fmat(idx21,2)    + idx11    *fmat(idx20,1)*fmat(idx11,2)    *fmat(idx30,3)
   !           !sum2 = sum2 + c5z[j]*((inJ - 1)*fmat[0][inI]  *fmat[1][inJ - 1] + (inI - 1)*fmat[0][inJ] *fmat[1][inI - 1])*fmat[2][inK];
   !            tem3 = tem3 + c5z(j)*(fmat(idx10,1)*fmat(idx20,2) + fmat(idx20,1)*fmat(idx10,2))*idx31    *fmat(idx31,3)
   !           !sum3 = sum3 + c5z[j]*(fmat[0][inI] *fmat[1][inJ]  + fmat[0][inJ] *fmat[1][inI]) *(inK - 1)*fmat[2][inK - 1];


                 !dr(3 + ii,i) = dVa...
                 !dr(6 + ii,i) = dVa...
                 !dr(0 + ii) = -( dr(3 + ii,i) + dr(6 + ii,i) ) ! O 


            !do ii = 1,9
            !    print*, "dr:", dr(ii,i)*27.211396132*A2b
            !enddo
             
             
            ! !// derivatives
            ! 
            ! const double dVcdr1 =
            !     (-2*b1*efac*(dROH1 - reoh)*sum0 + efac*sum1/reoh)/dROH1;
            ! 
            ! const double dVcdr2 =
            !     (-2*b1*efac*(dROH2 - reoh)*sum0 + efac*sum2/reoh)/dROH2;
            ! 
            ! const double dVcdcth = efac*sum3;
            ! 
            ! for (size_t i = 0; i < 3; ++i) {
            !     // H1
            !     dr[3 + i] = dVa1*ROH1[i] + dVb*RHH[i] + dVcdr1*ROH1[i]
            !     + dVcdcth*(ROH2[i]/(dROH1*dROH2) - costh*ROH1[i]/(dROH1*dROH1));
            !     // H2
            !     dr[6 + i] = dVa2*ROH2[i] - dVb*RHH[i] + dVcdr2*ROH2[i]
            !     + dVcdcth*(ROH1[i]/(dROH1*dROH2) - costh*ROH2[i]/(dROH2*dROH2));
            !     // O
            !     dr[0 + i] = -(dr[3 + i] + dr[6 + i]);
            ! }
            !
            ! I dont think Ineed this:  
            ! for (size_t i = 0; i < 9; ++i)
            !     dr[i] *= constants::cm1_eV; !// cm-1 --> eV
                
            
